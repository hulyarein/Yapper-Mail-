{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Email</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #fdeced, #fdeced, #fff1f1, #fff7f7);
            background-color: #fff1f1;
            background-repeat: no-repeat;
            display: flex;
            flex-direction: column;
            font-family: Helvetica;
        }

        .logoImage {
            width: 250px;
            height: 250px;
            background-color: white;
            padding: 10px;
            border-radius: 1000px;
            margin-bottom: 20px;
            margin-top: -150%;
            animation-name: showLog;
            animation-duration: 1s;
            animation-fill-mode: forwards;
        }

        .bodyContent {
            display: flex;
            flex-direction: row;
            height: 100vh;

        }

        .firstVert {
            background-color: #ffb3b7;
            min-width: 300px;
            color: white;
            box-shadow: 0px 0px 10px rgb(100, 100, 100);
            display: flex;
            flex-direction: column;
            z-index: 10;
            align-items: center;
            max-height: 100vh;
            height: 100vh;
            min-height: 500px;
            overflow: auto;
        }

        .secondVert {
            width: 100%;
            background: linear-gradient(to bottom, #fdeced, #fdeced, #fff1f1, #fff7f7);
            background-color: #fff1f1;
            display: flex;
            flex-direction: column;
            z-index: 8;
            list-style-type: none;
            padding-top: 20px;
            padding-left: 20px;
            padding-right: 20px;
            max-height: 100vh;
            min-height: 417px;
            height: 90vh;
            overflow: auto;
        }

        .typing-container {
            display: inline-block;
            overflow: hidden;
            white-space: nowrap;
            width: 26ch;
            /* Adjust the width based on the length of your text */
            border-right: none;
            animation: typing 1.5s steps(25), blink 0.5s step-end infinite;
            animation-fill-mode: forwards;
        }

        .typing-container2 {
            display: inline-block;
            overflow: hidden;
            white-space: nowrap;
            width: 18ch;
            visibility: hidden;
            /* Adjust the width based on the length of your text */
            border-right: none;
            animation: typing2 1.5s steps(18), blink 0.5s step-end infinite;
            animation-delay: 2s;
            /* Delay matches the duration of the first animation */
            animation-fill-mode: forwards;
        }

        .typing {
            color: white;
            margin-bottom: 0px;
            font-size: 25px;
            font-weight: bold;
            text-align: center;
        }

        .typing2 {
            color: white;
            margin-bottom: 0px;
            font-size: 25px;
            font-weight: bold;
            text-align: center;
        }

        .clearChat {
            background-color: #E46F41;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .clearChat:hover {
            padding: 15px;
        }

        * {
            transition: 0.2s;
        }

        .listcontright {
            display: flex;
            flex-direction: row;
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: end;
            margin-bottom: 20px;
        }

        .listcontleft {
            display: flex;
            flex-direction: row;
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: start;
            margin-bottom: 10px;
        }

        .listsubcontright {
            margin-right: 10px;
            margin-left: 10px;
        }

        .listsubcontleft {
            margin-left: 10px;
            margin-right: 10px;
        }

        .botPic {
            width: 40px;
            height: 40px;
        }

        .profPic {
            width: 40px;
            height: 40px;
            border-radius: 1000px;
        }

        .listContent {
            max-width: 80%;
            background-color: #fdc9cb;
            word-break: break-all;
            padding: 10px;
            border-radius: 5px;
            color: black;
        }

        .leftDiv {
            display: flex;
            justify-content: flex-end;
            flex-direction: row;
        }

        .rightDiv {
            display: flex;
            justify-content: flex-start;
            flex-direction: row;
        }

        .secVertMain {
            height: 100vh;
            max-height: 100vh;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 100%;
        }

        .getInput {
            width: 95%;
            font-size: 15px;
            padding: 10px 10px;
            height: 70px;
            margin-left: 10px;
            border-radius: 5px;
            border-style: solid;
            border-width: 2px;
            border-color: rgb(177, 177, 177);
        }

        .sendDiv {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .sendPrompt {
            cursor: pointer;
        }

        @media (max-height:624px) {
            .logoImage {
                margin-top: 20px;
                animation-name: showLog2;
            }
        }

        @media (max-height:560px) {
            .logoImage {
                height: 180px;
                width: 180px;
            }
        }

        @media (max-width:560px) {
            .logoImage {
                display: none;
            }

            .firstVert {
                min-width: 120px;
            }

            .typing-container,
            .typing-container2 {
                display: none;
            }

            .typing,
            .typing2 {
                display: none;
            }
        }

        @keyframes typing {
            from {
                width: 0;
            }

            to {
                width: 26ch;
            }
        }

        @keyframes typing2 {
            from {
                visibility: visible;
                width: 0;
            }

            to {
                visibility: visible;
                width: 18ch;
            }
        }

        @keyframes blink {
            50% {
                border-color: transparent;
            }
        }

        @keyframes showLog {
            from {
                margin-top: -150%;
            }

            to {
                margin-top: 30%;
            }
        }

        @keyframes showLog2 {
            from {
                margin-top: -150%;
            }

            to {
                margin-top: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="bodyContent">
        <div class="firstVert">
            <div class="userPK" style="opacity: 0;">{{userPk.id}}</div>
            <img src="{% static 'images/chatbotRob.png' %}" class="logoImage">
            <div class="typing-container">
                <p class="typing">Hello, I am Yapster,</p>
            </div>
            <div class="typing-container2">
                <p class="typing2">An AI Helper.</p>
            </div>
            <div class="clearChat">Clear Chat</div>
        </div>
        <div class="secVertMain">
            <ul class="secondVert">

                {% for prompt in userPrompt %}
                {% if prompt.fromAi %}
                <li class="listcontleft">
                    <div class="listsubcontleft">
                        <img src="{% static 'images/chatbotRob.png' %}" class="botPic">
                    </div>
                    <div class="listContent">
                        {{prompt.prompt_text}}
                    </div>
                </li>
                {% else %}
                <li class="listcontright">
                    <div class="btn-group dropleft">
                        <div style="display: flex; flex-direction: row; align-items: center; cursor: pointer;"
                            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img src="{% static 'images/down-arrow.png'%}"
                                style="color:#fd5e66; height: 20px; width: 20px; display: flex; flex-direction: row; align-items: center; margin-right: 5px;">
                        </div>

                        <div class="dropdown-menu">
                            <div style="opacity: 0; font-size: 2px;">{{prompt.id}}</div>
                            <button class="dropdown-item deletemess" type="button">Delete</button>
                            <button class="dropdown-item editmess" type="button">Edit</button>
                        </div>
                    </div>
                    <div class="listContent">
                        {{prompt.prompt_text}}
                    </div>
                    <div class="listsubcontright">
                        <img src="{{profilepic}}" class="profPic">
                    </div>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
            <div class="sendDiv">
                <textarea class="getInput"></textarea>
                <img src="{% static 'images/send.png' %}" style="height: 30px; width: 30px;" class="sendPrompt">
            </div>
        </div>
    </div>
</body>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    $(document).ready(function (e) {
        const parentElementvv = document.querySelector('.secondVert');
        parentElementvv.scrollTop = parentElementvv.scrollHeight;
        $(".sendPrompt").click(function (e) {
            var inputPrompt = document.querySelector(".getInput")
            var inputValue = inputPrompt.value.trim()
            if (inputPrompt.value.trim() == "") {
                console.log("none")
                return;
            }

            const parentElement = document.querySelector('.secondVert');

            const listItem = document.createElement('li');
            listItem.classList.add('listcontright');

            const btnGroup = document.createElement('div');
            btnGroup.classList.add('btn-group', 'dropleft');
            btnGroup.style.opacity = 0

            const dropdownToggle = document.createElement('div');
            dropdownToggle.style.cssText = "display: flex; flex-direction: row; align-items: center; cursor: pointer;";
            dropdownToggle.setAttribute('data-bs-toggle', 'dropdown');
            dropdownToggle.setAttribute('aria-haspopup', 'true');
            dropdownToggle.setAttribute('aria-expanded', 'false');

            const arrowImg = document.createElement('img');
            arrowImg.src = "{% static 'images/down-arrow.png' %}";
            arrowImg.style.cssText = "color:#fd5e66; height: 20px; width: 20px; margin-right: 5px;";

            dropdownToggle.appendChild(arrowImg);

            const dropdownMenu = document.createElement('div');
            dropdownMenu.classList.add('dropdown-menu');

            const deleteButton = document.createElement('button');
            deleteButton.classList.add('dropdown-item', 'deletemess');
            deleteButton.setAttribute('type', 'button');
            deleteButton.textContent = 'Delete';

            const editButton = document.createElement('button');
            editButton.classList.add('dropdown-item', 'editmess');
            editButton.setAttribute('type', 'button');
            editButton.textContent = 'Edit';

            var idme = document.createElement('div')
            idme.innerText = ""
            idme.style.opacity = "0"
            idme.style.fontSize = "2px"

            dropdownMenu.appendChild(idme);
            dropdownMenu.appendChild(deleteButton);
            dropdownMenu.appendChild(editButton);

            btnGroup.appendChild(dropdownToggle);
            btnGroup.appendChild(dropdownMenu);

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('listContent');
            contentDiv.textContent = inputValue;

            const rightContainer = document.createElement('div');
            rightContainer.classList.add('listsubcontright');

            const profileImg = document.createElement('img');
            profileImg.src = "{{profilepic}}";
            profileImg.classList.add('profPic');

            rightContainer.appendChild(profileImg);

            listItem.appendChild(btnGroup);
            listItem.appendChild(contentDiv);
            listItem.appendChild(rightContainer);

            parentElement.appendChild(listItem);

            parentElement.scrollTop = parentElement.scrollHeight;

            inputPrompt.value = ""

            sendDiv = document.querySelector(".sendDiv")
            sendDiv.style.pointerEvents = "none"
            sendDiv.style.opacity = "0.5"




            $.ajax({
                url: "../../chatbot/chatbotsystem/pass/",
                type: 'POST',
                data: JSON.stringify({ "message": inputValue }),
                contentType: 'application/json',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                success: function (response) {

                    const parentElement = document.querySelector('.secondVert');

                    const listItem = document.createElement('li');
                    listItem.classList.add('listcontleft');


                    const leftContainer = document.createElement('div');
                    leftContainer.classList.add('listsubcontleft');

                    const botPic = document.createElement('img');
                    botPic.src = "{% static 'images/chatbotRob.png' %}";
                    botPic.classList.add('botPic');

                    leftContainer.appendChild(botPic);

                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('listContent');
                    contentDiv.textContent = response.message;

                    listItem.appendChild(leftContainer);
                    listItem.appendChild(contentDiv);

                    parentElement.appendChild(listItem);
                    parentElement.scrollTop = parentElement.scrollHeight;

                    sendDiv.style.pointerEvents = "auto"
                    sendDiv.style.opacity = "1"

                    btnGroup.style.opacity = 1
                    idme.innerText = response.yourId
                    console.log(response.yourId)

                    deleteButton.addEventListener("click", function (e) {
                        var idHold = parseInt(e.target.parentElement.firstElementChild.innerText)
                        $.ajax({
                            url: "../../chatbot/chatbotdel/",
                            type: "POST",
                            data: JSON.stringify({ "idInp": idHold }),
                            contentType: 'application/json',
                            headers: { 'X-CSRFToken': getCookie('csrftoken') },
                            success: function (response) {
                                console.log(response)
                                window.location.reload()
                            }
                        })
                    })
                    editButton.addEventListener("click",function(e){
                        var editword = e.target.parentElement.parentElement.parentElement.firstElementChild.nextElementSibling.innerText
                        $(".getInput").val(editword)
                    })


                },
                error: function (error) {
                    console.error('An error occurred:', error.responseJSON);

                }
            });
        })

        $(".deletemess").click(function (e) {
            var idHold = parseInt(e.target.parentElement.firstElementChild.innerText)
            $.ajax({
                url: "../../chatbot/chatbotdel/",
                type: "POST",
                data: JSON.stringify({ "idInp": idHold }),
                contentType: 'application/json',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                success: function (response) {
                    console.log(response)
                    window.location.reload()
                }
            })
        })
        $(".editmess").click(function(e){
            var editword = e.target.parentElement.parentElement.parentElement.firstElementChild.nextElementSibling.innerText
            $(".getInput").val(editword)
        })
        $(".clearChat").click(function(e){
            $.ajax({
                url:"../../chatbot/chatbotdelall/",
                method:"POST",
                data: JSON.stringify({"idDel":parseInt($(".userPK").text())}),
                contentType: 'application/json',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                success:function(response){
                    console.log(response)
                    window.location.reload()
                }
            })
        })
    })
</script>

</html>
{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Yapper</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/landing.css" />
  </head>
  <body>
    <div class="home-container">
      <div class="home-navbar">
        <div class="logoo"></div>
        <form class="navbar-search" role="search">
          <input
            class="form-control search-bar"
            type="search"
            placeholder="Search"
            aria-label="Search"
          />
          <button
            class="btn btn-primary"
            style="
              border-radius: 20px;
              border-color: #f37d84;
              background-color: #f37d84;
              width: 7em;
            "
            type="submit"
          >
            Search
          </button>
        </form>

        <div class="compose-container">
          <i class="bi bi-plus-circle"></i>
          <a class="compose" href="{% url 'compose_email' pk=usermeid %}"
            >Compose</a
          >
        </div>

        <div class="dropdown notification-bell">
          <button
            type="button"
            id="notificationDropdown"
            class="btn btn-light"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            style="border: none; box-shadow: none; background-color: #fedee3"
          >
            <i
              class="bi bi-bell"
              style="color: #f37d84; font-size: 2em; background-color: #fedee3"
            ></i>
            <span
              id="notificationBadge"
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              style="display: none"
            >
              0
            </span>
          </button>
          <ul
            class="dropdown-menu dropdown-menu-end"
            aria-labelledby="notificationDropdown"
            id="notificationList"
          >
            <!-- Notifications will be dynamically added here -->
          </ul>
        </div>

        <div class="profile-container">
          <i class="bi bi-person-circle" style="color: #de3f2a"></i>
        </div>
      </div>

      <div class="home-body">
        <div class="home-body-1">
          <h3 style="color: #de3f2a">
            <span style="font-weight: bold"
              >Welcome {{ user.first_name|escape }}</span
            >
          </h3>
          <div class="navigation">
            <a href="{% url 'home' %}">
              <div class="navigation-item">
                <i class="bi bi-house-door-fill"></i> Dashboard
              </div>
            </a>

            <a>
              <div class="navigation-item clickInbox" style="cursor: pointer">
                <i class="bi bi-inbox"></i> Inbox
              </div>
            </a>

            <div class="navigation-item clickTeam" style="cursor: pointer">
              <i class="bi bi-people-fill"></i>
              <a>Team</a>
            </div>

            <div class="navigation-item">
              <i class="bi bi-calendar"></i>
              <a href="{% url 'login' %}">Calendar</a>
            </div>

            <div class="navigation-item clickchatBot" style="cursor: pointer">
              <i class="fas fa-robot"></i>
              <a>Chatbot</a>
            </div>
          </div>

          <div class="account-navigation">
            <span style="color: #f37d84">Account</span>

            <a href="{% url 'profile' %}">
              <div class="navigation-item">
                <i class="bi bi-person-circle"></i> Account
              </div>
            </a>

            <div class="navigation-item">
              <i class="bi bi-gear-fill"></i>
              <a href="{% url 'login' %}">Logout</a>
            </div>
          </div>

          <div class="recent-navigation">
            <span style="color: #f37d84">Recent</span>
            <div class="recent-navigation-container">
              <div
                class="recent-navigation-item"
                style="background-color: green"
              ></div>
              <div
                class="recent-navigation-item"
                style="background-color: orange"
              ></div>
              <div
                class="recent-navigation-item"
                style="background-color: purple"
              ></div>
              <div
                class="recent-navigation-item"
                style="background-color: red"
              ></div>
              <div
                class="recent-navigation-item"
                style="background-color: blue"
              ></div>
            </div>
          </div>
        </div>

        <div class="home-body-2">
          <div class="welcome">
            {% if plans %} {% for plan in plans %}
            <span>{{ plan.date_sent|date:"l, F j, g:i A" }}</span>
            <h1 class="notification-msg" style="height: 3em">
              {{ plan.subject }}
            </h1>
            <span style="font-size: 1em; font-weight: bold"
              ><i class="bi bi-reply"></i>Reply</span
            >
            {% endfor %} {% else %}
            <div class="no-tasks">No plans available.</div>
            {% endif %}
          </div>
          <div class="schedule">
            <h1>My Schedule</h1>
          </div>
          <div class="taskboard">
            <h1>Task board</h1>
            {% if emails %} {% for email in emails %}
            <div class="taskboard-container">
              <div class="task-title">{{ email.subject }}</div>
              <div class="task-email">{{ email.fromUser}}</div>
              <div class="task-text">{{ email.content }}</div>
            </div>
            {% endfor %} {% else %}
            <div class="no-tasks">No emails available.</div>
            {% endif %}
            <div class="taskboard-container">
              <div class="task-title">Event Request</div>
              <div class="task-email">userone@101.com</div>
              <div class="task-text">
                Good day, I need to request assistance for an event this
                October...
              </div>
            </div>

            <div class="taskboard-container">
              <div class="task-title">Event Request</div>
              <div class="task-email">userone@101.com</div>
              <div class="task-text">
                Good day, I need to request assistance for an event this
                October...
              </div>
            </div>

            <div class="taskboard-container">
              <div class="task-title">Event Request</div>
              <div class="task-email">userone@101.com</div>
              <div class="task-text">
                Good day, I need to request assistance for an event this
                October...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /*click inbox to go this emailmanagement/emailList location*/
      var clickInbox = document.querySelector(".clickInbox");
      clickInbox.addEventListener("click", function (e) {
        window.location.href = "../emailmanagement/emailList";
      });

      var teamClick = document.querySelector(".clickTeam");
      teamClick.addEventListener("click", function (e) {
        window.location.href = "../teamemailmanagement/emailList";
      });

      var clickchatBot = document.querySelector(".clickchatBot");
      clickchatBot.addEventListener("click", function (e) {
        window.location.href = "../chatbot/chatbotsystem/";
      });

      let email, fromUser, subject, content;
      const currUser = "{{ user.username }}";
      const notificationList = document.querySelector("#notificationList");
      const notificationBadge = document.querySelector("#notificationBadge");
      const socket = new WebSocket(
        `ws://${window.location.host}/ws/socket-server/`
      );

      socket.onopen = () => {
        console.log("Connected to the global notifications WebSocket!");
      };

      socket.onclose = () => {
        console.log("Socket closed!");
      };

      socket.onmessage = (e) => {
        const data = JSON.parse(e.data);
        console.log("Reached");

        if (data.type === "email_notification") {
          email = data.email;
          fromUser = email.fromUser;
          subject = email.subject;
          content = email.content;
          console.log("Email data received:", fromUser, subject, content);
          console.log("Reached 2");

          if (email.toUser === currUser) {
            const notificationItem = document.createElement("li");
            notificationItem.classList.add("dropdown-item");
            notificationItem.innerHTML = `
                  <strong>${fromUser}</strong><br>${subject}<br><small>${content}</small>
                  <span class="unread-indicator" style="float: right; width: 8px; height: 8px; background-color: red; border-radius: 50%;"></span>
              `;

            notificationItem.addEventListener("click", () => {
              markNotificationAsRead({ fromUser, subject, content });
              notificationItem.classList.add("read-notification");
              notificationItem.querySelector(
                ".unread-indicator"
              ).style.display = "none"; // Remove the circle
            });

            notificationList.insertBefore(
              notificationItem,
              notificationList.firstChild
            );

            // Show the badge if there are unread notifications
            const notifications =
              JSON.parse(localStorage.getItem("notifications")) || [];
            notifications.push({ fromUser, subject, content, read: false });
            localStorage.setItem(
              "notifications",
              JSON.stringify(notifications)
            );

            const unreadCount = notifications.filter((n) => !n.read).length;
            notificationBadge.style.display = "block";
            notificationBadge.innerText = unreadCount;
          }
        }
      };

      function markNotificationAsRead(notification) {
        let notifications =
          JSON.parse(localStorage.getItem("notifications")) || [];
        notifications = notifications.map((notif) => {
          if (
            notif.fromUser === notification.fromUser &&
            notif.subject === notification.subject
          ) {
            notif.read = true;
          }
          return notif;
        });
        localStorage.setItem("notifications", JSON.stringify(notifications));

        // Update badge count
        const unreadCount = notifications.filter((n) => !n.read).length;
        notificationBadge.innerText = unreadCount;
        if (unreadCount === 0) {
          notificationBadge.style.display = "none";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const notifications =
          JSON.parse(localStorage.getItem("notifications")) || [];

        notifications.forEach((notification) => {
          const notificationItem = document.createElement("li");
          notificationItem.classList.add("dropdown-item");
          if (notification.read) {
            notificationItem.classList.add("read-notification");
          }
          notificationItem.innerHTML = `
            <strong>${notification.fromUser}</strong><br>${
            notification.subject
          }<br><small>${notification.content}</small>
            ${
              !notification.read
                ? '<span class="unread-indicator" style="float: right; width: 8px; height: 8px; background-color: red; border-radius: 50%;"></span>'
                : ""
            }
        `;

          /* notificationItem.addEventListener("click", () => {

            markNotificationAsRead(notification);
            notificationItem.classList.add("read-notification");
            const unreadIndicator = notificationItem.querySelector(".unread-indicator");
            if (unreadIndicator) {
                unreadIndicator.style.display = "none"; // Remove the circle
            }

            fetch('/email_view/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fromUser: notification.fromUser,
                    subject: notification.subject,
                    content: notification.content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // After storing the email data, send GET request to retrieve it
                    fetch('/retrieve_email_view/', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.email_data) {
                            // Now you have the email data, and you can do something with it
                            console.log(data.email_data);  // Render email view, etc.

                            // Redirect to email view after retrieving data
                            window.location.href = '/receive_view/';
                        } else {
                            console.log('Error: No email data found');
                        }
                    })
                    .catch(error => console.error('Error fetching email data:', error));
                }
            })
            .catch(error => console.error('Error sending email data:', error));
        }); */

          console.log("Here");
          notificationList.insertBefore(
            notificationItem,
            notificationList.firstChild
          );
        });

        const unreadCount = notifications.filter((n) => !n.read).length;
        notificationBadge.style.display = unreadCount > 0 ? "block" : "none";
        notificationBadge.innerText = unreadCount;
      });
    </script>

    <!-- Bootstrap JS (including Popper.js for dropdowns) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
